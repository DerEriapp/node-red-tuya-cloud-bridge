<script type="text/html" data-template-name="device-node">
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-server"></i> Server</label>
        <select id="node-input-server"></select>
    </div>
    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-microchip"></i> Gerät</label>
        <select id="node-input-device"></select> 
        <button id="node-input-device-refresh" class="red-ui-button"><i class="fa fa-refresh"></i></button>
    </div>
    <div class="form-row">
        <label for="node-input-interval_time"><i class="fa fa-clock-o"></i> Check State Interval (s)</label>
        <input type="text" id="node-input-interval_time" placeholder="10" />
    </div>
    <div class="form-row">
        <label for="node-input-interval_active"><i class="fa fa-clock-o"></i> Interval aktiv</label>
        <input
            type="checkbox"
            id="node-input-interval_active"
            style="display: inline-block; width: auto; vertical-align: top;" />
    </div>
    <div class="form-row">
        <label for="node-input-debug"><i class="fa fa-bug"></i> Debug</label>
        <input type="checkbox" id="node-input-debug" style="display: inline-block; width: auto; vertical-align: top;" />
    </div>
</script>
<script type="text/javascript">
    RED.nodes.registerType("device-node", {
        inputs: 1,
        outputs: 1,
        label: function () {
            return this.device_name || "Tuya Device";
        },
        paletteLabel: "Tuya Device",
        category: "TUYA Cloud Bridge",
        color: "#ff4800",
        icon: "tuya-api-icon.png",
        defaults: {
            server: { value: "", type: "server-node", required: true },
            device_name: { value: "", required: true},
            device_id: { value: "" },
            interval_time: { value: "60" },
            interval_active: { value: true },
            debug: { value: false }
        },
        oneditprepare: function () {
            let deviceSelect = $("#node-input-device");
            deviceSelect.empty();

            let selectedDevice = this.device_id || ""; // gespeicherter Wert

            $.getJSON("/getDevices", function (devices) {
                //node.error("SERVER VALUE: " + JSON.stringify(node.server));

                if (devices.length === 0) {
                    deviceSelect.append($("<option></option>").attr("value", "").text("Keine Geräte gefunden"));
                } else {
                    deviceSelect.append($("<option></option>").attr("value", "").text(""));

                    devices.forEach((device) => {
                        let option = $("<option></option>").attr("value", device.id).text(device.name);

                        if (device.id === selectedDevice) {
                            option.attr("selected", "selected");
                        }

                        deviceSelect.append(option);
                    });

                    // Jetzt den gespeicherten Wert wiederherstellen
                    // //Not realy performant
                    //deviceSelect.val(selectedDevice);
                }
            });

            // Beim Klick auf den refresh button
            $("#node-input-device-refresh").on("click", function (e) {
                e.preventDefault();
                $.getJSON("/refreshDevices", function (devices) {
                    //node.error("SERVER VALUE: " + JSON.stringify(node.server));
                    deviceSelect.clear();
                    if (devices.length === 0) {
                        deviceSelect.append($("<option></option>").attr("value", "").text("Keine Geräte gefunden"));
                    } else {
                        deviceSelect.append($("<option></option>").attr("value", "").text(""));

                        devices.forEach((device) => {
                            let option = $("<option></option>").attr("value", device.id).text(device.name);

                            if (device.id === selectedDevice) {
                                option.attr("selected", "selected");
                            }

                            deviceSelect.append(option);
                        });

                        // Jetzt den gespeicherten Wert wiederherstellen
                        // //Not realy performant
                        //deviceSelect.val(selectedDevice);
                    }
                });
            });
            
            $("#node-input-debug").on("click", function () {
                if (this.checked === true) {
                    debug = true;
                    $("#node-input-debug").removeClass("selected");
                } else {
                    debug = false;
                    $(this).addClass("selected");
                }
            });
            $("#node-input-interval_active").on("click", function () {
                if (this.checked === true) {
                    interval_active = true;
                    $("#node-input-interval_active").removeClass("selected");
                } else {
                    interval_active = false;
                    $(this).addClass("selected");
                }
            });
        },
        oneditsave: function () {
            //If no device selected, keep the old selected one
            if ($("#node-input-device option:selected").text() != "") {
                this.device_id = $("#node-input-device").val();
                this.device_name = $("#node-input-device option:selected").text();
            }
        }
    });
</script>
